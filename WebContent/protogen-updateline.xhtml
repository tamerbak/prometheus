<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

<ui:composition template="#{frontController.masterPage}">

	<ui:define name="contenu">
		<p:growl id="frgrl" showDetail="true" />
		<p:poll interval="600" id="mypoll" widgetVar="mypoll" immediate="true"
			listener="#{frontController.pollWorkflows}" update="frgrl" />

		<div class="index-center">
			<hgroup id="main-title" class="thin">
			<h1 class="titleH1">
				<h:outputText value="#{formViewController.windowTitle}"></h:outputText>
			</h1>
			</hgroup>
		</div>

		<h2 style="padding-left: 10px;">
			<h:outputText value="#{formViewController.processMessage}"
				styleClass="#{formViewController.messageClass}"></h:outputText>
		</h2>
		<br />

		<p:dialog id="dlg2" closable="false" widgetVar="dlg2" modal="false"
			resizable="false" dynamic="false">
			<p:graphicImage value="/images/loading.gif" />
			<p:spacer width="20" height="10" />
			<label style="position: relative; bottom: 10px;">Chargement
				...</label>
		</p:dialog>
		<p:dialog id="inlineinsert" widgetVar="inlineinsert" modal="false"
			resizable="false" header="#{formViewController.toCreateEntity.name}"
			dynamic="true">

			<p:panelGrid id="inlineinsertgrid"
				style="width:100%;padding:40px;background:none;border:none !important;">
				<c:forEach var="ctline"
					items="#{formViewController.icLines.ctlines}">
					<p:row>
						<c:forEach var="uictrl" items="#{ctline.controls}">
							<p:column styleClass="column-form-proc" style="border: 1px solid whitesmoke;">
								<h:outputText value="#{uictrl.controlID}" styleClass="outputLabel-custom" />&nbsp;
							</p:column>
						</c:forEach>
					</p:row>
					
					<p:row>
						<c:forEach var="uictrl" items="#{ctline.controls}">
							<p:column colspan="#{uictrl.colspan}">
								
								<p:inputText id="idtext_#{uictrl.attribute.id}"
									value="#{uictrl.controlValue}"
									readonly="#{uictrl.attribute.calculated or uictrl.readOnly or uictrl.attribute.CAttributetype.id==7 }"
									rendered="#{!uictrl.attribute.textarea and !uictrl.reference and !uictrl.ctrlDate and uictrl.attribute.CAttributetype.id!=5 and uictrl.attribute.CAttributetype.id!=9 and uictrl.attribute.CAttributetype.id!=6 and uictrl.attribute.CAttributetype.id!=12 }"
									onclick="this.select();" style="width:125px"
									validatorMessage="#{uictrl.attribute.regexpMessage}">
									<p:ajax event="blur"
										listener="#{formViewController.saveTextStatus}" />
									<f:validateRegex disabled="#{!uictrl.attribute.regular}"
										pattern="#{uictrl.attribute.regexp}"></f:validateRegex>
								</p:inputText>
								<p:spacer width="3"
									rendered="#{!uictrl.reference and !uictrl.ctrlDate and uictrl.attribute.CAttributetype.id!=5 and uictrl.attribute.CAttributetype.id!=9 and uictrl.attribute.CAttributetype.id!=6 and uictrl.attribute.CAttributetype.id!=12 }"
									height="3" />
								<h:outputText rendered="#{uictrl.money}"
									value="#{formViewController.moneyCode}" />

								<p:inputTextarea id="idtextarea_#{uictrl.attribute.id}"
									value="#{uictrl.controlValue}"
									readonly="#{uictrl.attribute.calculated or uictrl.readOnly or uictrl.attribute.CAttributetype.id==7 }"
									rendered="#{uictrl.attribute.textarea and !uictrl.reference and !uictrl.ctrlDate and uictrl.attribute.CAttributetype.id!=5 and uictrl.attribute.CAttributetype.id!=9 and uictrl.attribute.CAttributetype.id!=6}"
									onclick="this.select();" style="width:125px">
									<p:ajax event="keyup" listener="#{formViewController.saveTextStatus}" />
								</p:inputTextarea>

								<p:selectBooleanCheckbox value="#{uictrl.booleanValue}" 
									rendered="#{uictrl.attribute.CAttributetype.id==12}" >
									<p:ajax event="change" listener="#{formViewController.dummyListener}" update="@this" />
								</p:selectBooleanCheckbox>
								
								<p:calendar pattern="#{frontController.localization.dateFormat}" locale="#{frontController.localization.langCode}" navigator="true"
									id="idcalendar_#{uictrl.attribute.id}"
									value="#{uictrl.dateValue}" rendered="#{uictrl.ctrlDate}">
								</p:calendar>


								
								<p:inputMask id="idmask_#{uictrl.attribute.id}"
									value="#{uictrl.controlValue}"
									rendered="#{uictrl.attribute.CAttributetype.id==5}"
									mask="99:99" style="width:125px">
								</p:inputMask>


								<p:selectOneMenu id="idselect_#{uictrl.attribute.id}"
									value="#{uictrl.trueValue}" rendered="#{uictrl.reference}"
									styleClass="dropdown" style="width:132px"
									filter="#{uictrl.filtrable}" filterMatchMode="contains">
									<p:ajax event="change"
										listener="#{formViewController.inlineReferenceChange}" />
									<f:selectItem itemLabel="" itemValue="" />
									<f:selectItems var="ke" value="#{uictrl.listReference}"
										itemValue="#{ke.value}" itemLabel="#{ke.value}"></f:selectItems>
								</p:selectOneMenu>

								
								
								<p:selectOneMenu id="idvalidate_#{uictrl.attribute.id}"
									value="#{uictrl.trueValue}"
									rendered="#{uictrl.attribute.CAttributetype.id==9}"
									styleClass="dropdown" style="width:132px">
									<f:selectItem itemLabel="#{uictrl.attribute.unlockLabel}"
										itemValue="Non" />
									<f:selectItem itemLabel="#{uictrl.attribute.lockLabel}"
										itemValue="Oui" />
								</p:selectOneMenu>

							</p:column>

						</c:forEach>
					</p:row>
				</c:forEach>
			</p:panelGrid>
			<f:facet name="footer">
				<p:commandButton value="Enregistrer" immediate="true"
					icon="ui-icon-check"
					actionListener="#{formViewController.saveInline}"
					ajax="false"
					oncomplete="PF('dlg2').hide();PF('inlineinsert').hide();$('.tab_content').parent('div.ui-tabs-panel').hide();$('.onglet_#{formViewController.activeMtmBlockId}').parent('div.ui-tabs-panel').show();" update="@form" />
				<p:commandButton value="Annuler" immediate="true"
					icon="ui-icon-close" oncomplete="inlineinsert.hide();"
					update=":protogen_main:inlineinsert" />
			</f:facet>

		</p:dialog>


		<p:messages id="messagesvalidation" />
		<h:outputText id="dummymsg" value="" />
		<p:hotkey bind="ctrl+s" action="#{formViewController.doSave}"
			update="@form" immediate="true" onstart="PF('dlg2').show();" oncomplete="PF('dlg2').hide();" />
		

		<p:panel id="parapanel"
			rendered="#{formViewController.parameteredEntity}"
			header="Paramétrage" toggleable="true">
			<p:panelGrid id="parapagrid" style="width:100%">
				<f:facet name="header">
					<p:row>
						<p:column colspan="2">Choix du modèle de paramétrage</p:column>
					</p:row>
				</f:facet>
				<p:row>
					<p:column styleClass="column-admin">
						<h:outputText value="Modèle" styleClass="outputLabel-custom" />
					</p:column>
					<p:column>
						<p:selectOneMenu id="modelParametrage"
							value="#{formViewController.selectedComponentName}">
							<p:ajax ecent="change"
								listener="#{formViewController.modelParametrageChanged}"
								update="@form" onstart="PF('dlg2').show();" oncomplete="PF('dlg2').hide();" />
							<f:selectItem itemLabel="" itemValue="" />
							<f:selectItems value="#{formViewController.parametersComponents}"
								var="pc" itemValue="#{pc.modelName}" itemLabel="#{pc.modelName}" />
						</p:selectOneMenu>
					</p:column>
				</p:row>
				<p:row>
					<p:column styleClass="column-admin">
						<h:outputText value="Paramètres de configuration" styleClass="outputLabel-custom" />
					</p:column>
					<p:column>
						<p:selectOneMenu id="modelParametrageInstance"
							value="#{formViewController.selectedInstance}">
							<f:selectItem itemLabel="" itemValue="" />
							<f:selectItems
								value="#{formViewController.selectedComponent.modelInstances}"
								var="pc" itemValue="#{pc.dbID}" itemLabel="#{pc.value}" />
						</p:selectOneMenu>
					</p:column>
				</p:row>
			</p:panelGrid>
		</p:panel>
		<div style="display:#{formViewController.singleMode?'':'none'}"
			class="wrapped align-left white-gradient glossy large-box-shadow">

			<p:commandButton value="Nouveau"
				styleClass="button margin-right button-icon green-gradient glossy"
				rendered="#{listViewControl.window.formId gt 0 and formViewController.singleMode}"
				action="#{frontController.updateScreenThroughLink}" ajax="false">
				<f:param name="screenseq" value="#{listViewControl.window.formId}" />
				<f:param name="tonew" value="1" />
			</p:commandButton>

			<p:commandButton rendered="#{listViewControl.deleteBtn}"
				styleClass="button margin-right button-icon red-gradient glossy"
				value="Supprimer" update="@form"
				action="#{formViewController.doPrimeDelete}" onstart="PF('dlg2').show();"
				oncomplete="PF('dlg2').hide();reShowActiveMenu();" />

			
		</div>
		<details class="details margin-bottom" open="true"> 
			<summary class="summaryDetails">
				<h:outputText value="#{formViewController.windowTitle}" />
				<h:outputText rendered="#{formViewController.alphaMode}" value=" (#{formViewController.alphaEntity} : #{formViewController.alphaReference})" />
				
				<p:commandButton ajax="false" immediate="true" action="#{formViewController.backButton}" icon="ui-icon-triangle-1-w" style="position: absolute;right: 42px;" rendered="#{formViewController.navigation}" />
				<p:commandButton ajax="false" immediate="true" action="#{formViewController.nextButton}" icon="ui-icon-triangle-1-e" style="position: absolute;right: 0px;" rendered="#{formViewController.navigation}" />
			</summary>
				<p:panel id="panel" style="margin: 0px; padding: 0px;">
					<p:focus context="panel" />
					<p:panelGrid id="formgridlines" style="width:100%; padding: 0px;">
						<c:forEach var="ctline"
							items="#{formViewController.controlLines.ctlines}">
							<!-- Labels -->
							<p:row>
								<c:forEach var="uictrl" items="#{ctline.controls}">
									<p:column rendered="#{!uictrl.hide}" styleClass="column-admin" 
										style="border: 1px solid whitesmoke;font-size: 13px !important;padding:5px 5px !important;">
										<h:outputText value="#{uictrl.controlID}" />&nbsp; <p:graphicImage
											value="img/bulb.png"
											title="Ce champs sera calculé suite à la validation du formulaire"
											rendered="#{uictrl.visible and uictrl.attribute.calculated}"
											styleClass="outputLabel-custom" />
										<p:graphicImage style="margin-bottom: 6%;margin-left: 3%; width:5px" rendered="#{uictrl.attribute.mandatory}"
											value="/img/create#{frontController.themeVar}.png" />
										<p:graphicImage value="img/bulb.png"
											title="Ce champs en lecture seule vous offre plus d'informations sur les choix effectués"
											rendered="#{uictrl.readOnly}" />

									</p:column>
									

								</c:forEach>
							</p:row>
							<!-- Values -->
							<p:row>
								
								<c:forEach var="uictrl" items="#{ctline.controls}">
									<p:column rendered="#{!uictrl.hide}" colspan="#{uictrl.colspan}" 
										style="border: 1px solid whitesmoke;padding: 2px 2px !important;">
										<p:inputText id="idtext_#{uictrl.attribute.id}"
											value="#{uictrl.controlValue}"
											required="#{uictrl.attribute.mandatory}"
											requiredMessage="Le champs #{uictrl.controlID} est obligatoire"
											readonly="#{uictrl.attribute.calculated or uictrl.readOnly or uictrl.attribute.CAttributetype.id==7}"
											rendered='#{uictrl.visible and !uictrl.attribute.textarea and !uictrl.reference and !uictrl.ctrlDate and uictrl.attribute.CAttributetype.id!=5 and uictrl.attribute.CAttributetype.id!=12 and uictrl.attribute.CAttributetype.id!=9 and uictrl.attribute.CAttributetype.id!=6 and uictrl.attribute.CAttributetype.id!=10 and uictrl.attribute.CAttributetype.id!=11}'
											onclick="this.select();" style="width:125px"
											validatorMessage="#{uictrl.attribute.regexpMessage}">
											<p:ajax event="keyup"
												update="#{uictrl.attribute.conditionalLayout?'dummymsg':formViewController.updatedFields}"
												listener="#{formViewController.saveTextStatus}" />
											<f:validateRegex disabled="#{!uictrl.attribute.regular}"
												pattern="#{uictrl.attribute.regexp}"></f:validateRegex>
										</p:inputText>
										<p:spacer width="3"
											rendered="#{!uictrl.reference and !uictrl.ctrlDate and uictrl.attribute.CAttributetype.id!=5 and uictrl.attribute.CAttributetype.id!=9 and uictrl.attribute.CAttributetype.id!=6}"
											height="3" />
										<h:outputText rendered="#{uictrl.money}"
											value="#{formViewController.moneyCode}" />
											
										<p:inputTextarea id="idtextarea_#{uictrl.attribute.id}"
											value="#{uictrl.controlValue}"
											readonly="#{uictrl.attribute.calculated or uictrl.readOnly or uictrl.attribute.CAttributetype.id==7 }"
											rendered="#{uictrl.attribute.textarea and !uictrl.reference and !uictrl.ctrlDate and uictrl.attribute.CAttributetype.id!=5 and uictrl.attribute.CAttributetype.id!=9 and uictrl.attribute.CAttributetype.id!=6}"
											onclick="this.select();" cols="20" rows="3" autoResize="true">
											<p:ajax event="blur" listener="#{formViewController.saveTextStatus}" />
										</p:inputTextarea>

										<!-- Boolean -->
										<p:selectBooleanCheckbox value="#{uictrl.booleanValue}" 
											rendered="#{uictrl.attribute.CAttributetype.id==12}" >
											<p:ajax event="change" listener="#{formViewController.dummyListener}" update="@this" />
										</p:selectBooleanCheckbox>
											
										<!-- Calendar for date values -->
										<p:calendar pattern="#{frontController.localization.dateFormat}" locale="#{frontController.localization.langCode}" navigator="true"
											id="idcalendar_#{uictrl.attribute.id}"
											value="#{uictrl.dateValue}"
											required="#{uictrl.attribute.mandatory}"
											requiredMessage="Le champs #{uictrl.controlID} est obligatoire"
											rendered="#{uictrl.ctrlDate}">
											<p:ajax event="dateSelect"
												update="#{uictrl.attribute.conditionalLayout?'dummymsg':formViewController.updatedFields}"
												listener="#{formViewController.handleDateSelect}" />
										</p:calendar>


										<p:inputMask id="idmask_#{uictrl.attribute.id}"
											value="#{uictrl.controlValue}"
											required="#{uictrl.attribute.mandatory}"
											requiredMessage="Le champs #{uictrl.controlID} est obligatoire"
											rendered="#{uictrl.attribute.CAttributetype.id==5}"
											mask="99:99" style="width:125px">
											<p:ajax event="keyup"
												update="#{uictrl.attribute.conditionalLayout?'dummymsg':formViewController.updatedFields}"
												listener="#{formViewController.saveTextStatus}" />
										</p:inputMask>

										<p:commandButton type="button" id="olpbtn_#{uictrl.attribute.id}" immediate="true"
											icon="ui-icon-circle-triangle-s" rendered="#{uictrl.reference}" />
										<p:inputText rendered="#{uictrl.reference}" id="olprestext_#{uictrl.attribute.id}" readonly="true" 
											value="#{uictrl.trueValue}" style="width:110px" />
										<p:overlayPanel id="olpanel_#{uictrl.attribute.id}" widgetVar="wvolpanel_#{uictrl.attribute.id}" for="olpbtn_#{uictrl.attribute.id}" hideEffect="fade">
											<p:scrollPanel style="height:200px" >
												<p:panelGrid style="width:200px" id="olpanelpg_#{uictrl.attribute.id}" >
													<f:facet name="header">
														<p:row>
															<p:column colspan="2">
																<h:outputText value="#{uictrl.attribute.attribute}" />
															</p:column>
														</p:row>
														<p:row>
															<p:column style="width:7%">
																<p:commandButton icon="ui-icon-search" immediate="true"
																	actionListener="#{formViewController.updateReferenceKeys}" update="olpanelpg_#{uictrl.attribute.id}" >
																	<f:param name="CTRL_ID" value="#{uictrl.attribute.id}" />
																</p:commandButton>
															</p:column>
															<p:column>
																<p:inputText value="#{uictrl.searchKeyWords}" style="width:96%" >
																	<p:ajax event="blur" update="@this" listener="#{formViewController.inlineReferenceChange}" />
																</p:inputText>
															</p:column>
														</p:row>
													</f:facet>
													<c:forEach items="#{uictrl.listReference}" var="ke">
														<p:row>
															<p:column style="width:7%">
																<p:commandButton icon="ui-icon-circle-triangle-e"  immediate="true"
																	oncomplete="PF('wvolpanel_#{uictrl.attribute.id}').hide();PF('dlg2').hide();" onstart="PF('dlg2').show();" 
																	actionListener="#{formViewController.autoCompleteFieldSelect}" update="@form">
																	<f:param name="CTRL_ATT_ID" value="#{uictrl.attribute.id}" />
																	<f:param name="CTRL_ATT_VAL" value="#{ke.key}" />
																</p:commandButton>
															</p:column>
															<p:column>
																<h:outputText value="#{ke.value}" />
															</p:column>
														</p:row>
													</c:forEach>
												</p:panelGrid>
											</p:scrollPanel>
											
											
										</p:overlayPanel> 
										
										<p:spacer rendered="#{uictrl.reference}" width="2" height="10" />
										<p:commandLink title="Créer une nouvelle valeur"
											process="@this" immediate="true"
											actionListener="#{formViewController.loadInlineComponents}"
											onstart="PF('dlg2').show();" update="@form"
											rendered="#{uictrl.reference and uictrl.attribute.id gt 0}"
											oncomplete="PF('inlineinsert').show();PF('dlg2').hide();">
											<p:graphicImage style="width:12px;margin-bottom: 6%;margin-left: 3%;"
												value="/img/add.png" />
											<f:param name="inlineDataReference"
												value="#{uictrl.attribute.dataReference}" />
											<f:param name="inlineAttId" value="#{uictrl.attribute.id}" />
										</p:commandLink>

										
										<p:selectOneMenu id="idvalidate_#{uictrl.attribute.id}"
											value="#{uictrl.trueValue}"
											rendered="#{uictrl.attribute.CAttributetype.id==9}"
											styleClass="dropdown" style="width:132px">
											<f:selectItem itemLabel="#{uictrl.attribute.unlockLabel}"
												itemValue="Non" />
											<f:selectItem itemLabel="#{uictrl.attribute.lockLabel}"
												itemValue="Oui" />
										</p:selectOneMenu>

										<p:fileUpload id="idfichier_#{uictrl.attribute.id}"
											locale="#{frontController.localization.langCode}" cancelLabel="Annuler" label="Parcourir"
											uploadLabel="Charger"
											multiple="false"
											auto="true"
											fileUploadListener="#{formViewController.handleFileUpload}"
											update="@form" mode="advanced"
											rendered="#{uictrl.binaryContent}" />
											
										<p:selectOneMenu id="idmetatable_#{uictrl.attribute.id}"
											value="#{uictrl.controlValue}" rendered="#{uictrl.attribute.CAttributetype.id==10}"
											styleClass="dropdown" style="width:132px"
											filter="true" filterMatchMode="contains">
											<f:selectItem itemLabel="" itemValue="" />
											<f:selectItems var="ke" value="#{uictrl.listReference}"
												itemValue="#{ke.key}" itemLabel="#{ke.value}"></f:selectItems>
										</p:selectOneMenu>
										
										<p:selectOneMenu id="idrefmetatable_#{uictrl.attribute.id}"
											value="#{uictrl.controlValue}" rendered="#{uictrl.attribute.CAttributetype.id==11}"
											styleClass="dropdown" style="width:132px"
											filter="true" filterMatchMode="contains">
											<f:selectItem itemLabel="" itemValue="" />
											<f:selectItems var="ke" value="#{uictrl.listReference}"
												itemValue="#{ke.key}" itemLabel="#{ke.value}"></f:selectItems>
										</p:selectOneMenu>
										
										<br />

									</p:column>

								</c:forEach>
							</p:row>
							
						</c:forEach>
						<p:row rendered="#{formViewController.history.id gt 0}">
							<p:column styleClass="column-admin" 
									style="border: 1px solid whitesmoke;font-size: 13px !important;padding:5px 5px !important;">
								<h:outputText value="Date de début" />
							</p:column>
						</p:row>
						<p:row rendered="#{formViewController.history.id gt 0}">
							<p:column>
								<p:calendar value="#{formViewController.histoStart}" locale="#{frontController.localization.langCode}" 
									navigator="true" pattern="#{frontController.localization.dateFormat}" >
									<p:ajax event="dateSelect" listener="#{formViewController.histoChange}"
											update="@form" />
								</p:calendar>
							</p:column>
						</p:row>
						<p:row rendered="#{formViewController.uniqueRowMode}">
							<p:column colspan="5"><h:outputText value="Par défaut" /></p:column>
						</p:row>
						<p:row rendered="#{formViewController.uniqueRowMode}">
							<p:column colspan="5">
								<p:selectBooleanCheckbox value="#{formViewController.defaultChecked}" />
							</p:column>
						</p:row>
					</p:panelGrid>
				</p:panel>
		<table>
		<tr>
				<td colspan="2" class="with-padding" width="1000px" align="center"><p:commandButton
						ajax="false" action="#{formViewController.doSave}"
						value="Enregistrer"
						immediate="true"
						styleClass="button margin-right button-icon blue-gradient glossy">
						<p:resetInput target="panel" />
					</p:commandButton>
					<p:commandButton
						action="#{ frontController.updateScreenThroughLink }"
						rendered="#{formViewController.insert}" ajax="false"
						immediate="true" value="Annuler"
						styleClass="button margin-right button-icon red-gradient glossy">
						<f:param name="screenseq" value="#{frontController.lastWindow.id}" />
					</p:commandButton> <p:commandButton
						action="#{ frontController.updateScreenThroughLink }"
						rendered="#{!formViewController.insert}" ajax="false"
						immediate="true" value="Annuler"
						styleClass="button margin-right button-icon blue-gradient glossy">
						<f:param name="screenseq" value="#{frontController.window.id}" />
					</p:commandButton> <p:commandButton
						action="#{ frontController.updateScreenThroughLink }"
						rendered="#{!frontController.inProcess and frontController.linksAvailable and !frontController.singleLink}"
						ajax="false" immediate="true"
						value="#{frontController.lastWindow.title}"
						styleClass="button margin-right button-icon grey-gradient glossy">
						<f:param name="screenseq" value="#{frontController.lastWindow.id}" />
					</p:commandButton> <p:commandButton action="#{frontController.next}"
						rendered="#{frontController.inProcess and formViewController.saved}"
						ajax="false" immediate="true" value="Suivant"
						styleClass="button margin-right button-icon red-gradient glossy" />
					<p:commandButton
						action="#{ frontController.updateScreenThroughLink }"
						rendered="#{!frontController.inProcess and frontController.linksAvailable and !frontController.lastWindowAvailable}"
						ajax="false" immediate="true"
						value="#{frontController.firstLink.title}"
						styleClass="button margin-right button-icon red-gradient glossy">
						<f:param name="screenseq" value="#{frontController.firstLink.id}" />
					</p:commandButton></td>
			</tr>
		</table>
		</details>
		<p:treeTable value="#{formViewController.root}" var="org" 
			rendered="#{formViewController.localizedMode}"
			selection="#{formViewController.selectedOrg}" selectionMode="single" >
			<p:ajax event="select" listener="#{formViewController.onOrgSelect}" update="@this" />
			<p:column headerText="Niveau">
	            <h:outputText value="#{org.name}" />
	        </p:column>
		</p:treeTable>
		<p:panel style="width:100%" rendered="#{formViewController.compositionMode}" header="Composition" >
			<p:pickList id="picklistcomposition" value="#{formViewController.toCompose}" 
			 	var="cb" itemLabel="#{cb}" itemValue="#{cb}" style="width:100%"
			 	showSourceFilter="true" showTargetFilter="true" showSourceControls="false" showTargetControls="false" >
			</p:pickList>
		</p:panel>
		<p:tabView widgetVar="mtmAccordion" id="mtmAccordion" style="width:100%">
			<c:forEach var="mtmBlock" items="#{formViewController.mtmBlocks}" varStatus="loop">
				<p:ajax event="tabChange"
					listener="#{formViewController.onTabChange}" />
				<p:tab id="tabid_#{mtmBlock.entityID}" titleStyleClass="tab_title"  >
					<f:facet name="title">
		               <h:outputText value="#{mtmBlock.entity.name}" styleClass="tabTitle"/>
        	       	</f:facet>
					<h:panelGroup styleClass="tab_content onglet_#{mtmBlock.entityID}">
						<p:scrollPanel style="width:900px; height:250px">
							<p:dataTable value="#{mtmBlock.lines}" var="mtmLine" style="width:1500px" rowKey="#{mtmLine.key}" emptyMessage=""
								editable="true" id="lines_tabid_#{mtmBlock.entityID}" >
								<p:ajax event="rowEdit" listener="#{formViewController.mtmLineEditionListener}" update="@this" />
								<p:columns value="#{mtmBlock.titles}" var="col" columnIndexVar="colIndex" headerText="#{col}">
									<p:cellEditor>
										<f:facet name="output">
											<h:outputText value="#{mtmLine.values[colIndex].value}" rendered="#{!mtmLine.values[colIndex].date}" />
											<h:outputText value="#{mtmLine.values[colIndex].formattedDateValue}" rendered="#{mtmLine.values[colIndex].date}" />
										</f:facet>
										<f:facet name="input">
										<center>
											<p:inputText value="#{mtmLine.values[colIndex].value}" 
												rendered="#{!mtmLine.values[colIndex].date and mtmLine.values[colIndex].attribute.CAttributetype.id ne 12 and !mtmLine.values[colIndex].reference}"
												style="width:70px" />
											<p:calendar value="#{mtmLine.values[colIndex].dateValue}" styleClass="reduced-calendar"
												rendered="#{mtmLine.values[colIndex].date}" style="width:70px" />
											<p:selectBooleanCheckbox value="#{mtmLine.values[colIndex].booleanValue}"
												rendered="#{mtmLine.values[colIndex].attribute.CAttributetype.id==12}" />
											<h:selectOneMenu value="#{mtmLine.values[colIndex].value}"
												rendered="#{mtmLine.values[colIndex].reference}" styleClass="reduced-ddlist" >
												<f:selectItems value="#{mtmLine.values[colIndex].listReferences}" var="lr"
													itemLabel="#{lr.value}" itemValue="#{lr.value}" />
											</h:selectOneMenu>
										</center>
										</f:facet>
									</p:cellEditor>
								</p:columns>
								<p:column style="width:5%">
						           <p:rowEditor />
						       </p:column>
						       <p:column style="width:5%">
						       				<p:commandButton action="#{formViewController.doDelete}"
												icon="ui-icon-minus" update=":protogen_main:mtmAccordion" immediate="true"
												onstart="PF('dlg2').show();" oncomplete="PF('dlg2').hide();">
												<f:param name="todel" value="#{mtmLine.id}"></f:param>
												<f:param name="todelBlock" value="#{mtmBlock.entityID}"></f:param>
											</p:commandButton>
						       </p:column>
							</p:dataTable>
						</p:scrollPanel>

						<br />
						<center>
							<p:panelGrid columns="4" style="width:100%" 
								columnClasses="mtmcols, mtmcols, mtmcols, mtmcols">

								<c:forEach items="#{mtmBlock.controls}" var="mtmControl">
									<h:panelGrid columns="3">
										<h:outputText value="#{mtmControl.label}" style="vertical-align: middle;"></h:outputText>
										<p:graphicImage style="margin-bottom: 6%;margin-left: 3%; width:5px" rendered="#{mtmControl.attribute.mandatory}"
												value="/img/create#{frontController.themeVar}.png" />
										<p:graphicImage value="img/bulb.png"
											title="La valeur de ce champs sera calculée de façon automatique"
											rendered="#{mtmControl.attribute.calculated}" />
									</h:panelGrid>
									
									<h:panelGrid columns="1">
										<p:inputMask value="#{mtmControl.controlValue}"
											required="#{mtmControl.attribute.mandatory}"
											requiredMessage="Le champs #{mtmControl.controlID} est obligatoire"
											rendered="#{mtmControl.attribute.CAttributetype.id==5}"
											mask="99:99" style="width:125px">
											<p:ajax event="keyup"
												update="#{mtmControl.attribute.conditionalLayout?'dummymsg':formViewController.updatedFields}"
												listener="#{formViewController.saveTextStatus}" />
										</p:inputMask>
										
										<p:inputText value="#{mtmControl.controlValue}"
											readonly="#{mtmControl.attribute.calculated}"
											styleClass="#{(!mtmControl.reference and !mtmControl.ctrlDate)?'showTextbox':'hideTextbox'}"
											rendered="#{!uictrl.attribute.textarea and !mtmControl.reference and !mtmControl.ctrlDate and mtmControl.attribute.CAttributetype.id!=12 and mtmControl.attribute.CAttributetype.id!=5}"
											onclick="this.select();">
											<p:ajax event="blur" update="@this"></p:ajax>
										</p:inputText>
										
										<p:inputTextarea value="#{mtmControl.controlValue}"
											styleClass="#{(!mtmControl.reference and !mtmControl.ctrlDate)?'showTextbox':'hideTextbox'}"
											rendered="#{uictrl.attribute.textarea}"
											onclick="this.select();" cols="20" rows="3">
										</p:inputTextarea>
										
										
										<p:selectBooleanCheckbox value="#{mtmControl.booleanValue}" 
											rendered="#{mtmControl.attribute.CAttributetype.id==12}" >
											<p:ajax event="change" listener="#{formViewController.dummyListener}" update="@this" />
										</p:selectBooleanCheckbox>
										
										
										<p:calendar pattern="#{frontController.localization.dateFormat}" locale="#{frontController.localization.langCode}" navigator="true"
											value="#{mtmControl.dateValue}"
											styleClass="#{(mtmControl.ctrlDate)?'showCalendar':'hideCalendar'}"
											rendered="#{mtmControl.ctrlDate}">
											<p:ajax event="dateSelect"
												update="#{uictrl.attribute.conditionalLayout?'dummymsg':formViewController.updatedFields}"
												listener="#{formViewController.handleDateSelect}" />
										</p:calendar>
										<h:panelGrid columns="3">
											<p:commandButton type="button" id="olpbtn_#{mtmBlock.entityID}_#{mtmControl.attribute.id}" immediate="true"
												icon="ui-icon-circle-triangle-s" rendered="#{mtmControl.reference}" />
											<p:inputText rendered="#{mtmControl.reference}" id="olprestext_#{mtmBlock.entityID}_#{mtmControl.attribute.id}" readonly="true" 
												value="#{mtmControl.trueValue}" style="width:110px" />
											<p:commandLink title="Créer une nouvelle valeur"
												process="@this" immediate="true"
												actionListener="#{formViewController.loadInlineComponents}"
												onstart="PF('dlg2').show();" update="@form"
												rendered="#{mtmControl.reference and mtmControl.attribute.id gt 0}"
												oncomplete="PF('inlineinsert').show();PF('dlg2').hide();">
												<p:graphicImage style="width:12px;margin-bottom: 6%;margin-left: 3%;"
													value="/img/add.png" />
												<f:param name="inlineDataReference"
													value="#{mtmControl.attribute.dataReference}" />
												<f:param name="inlineAttId" value="#{uictrl.attribute.id}" />
											</p:commandLink>
											<p:overlayPanel id="olpanel_#{mtmBlock.entityID}_#{mtmControl.attribute.id}" 
												 widgetVar="wvolpanel_#{mtmBlock.entityID}_#{mtmControl.attribute.id}" 
												 for="olpbtn_#{mtmBlock.entityID}_#{mtmControl.attribute.id}" hideEffect="fade">
												<p:scrollPanel style="height:200px" >
													<p:panelGrid style="width:200px" id="olpanelpg_#{mtmBlock.entityID}_#{mtmControl.attribute.id}" >
														<f:facet name="header">
															<p:row>
																<p:column colspan="2">
																	<h:outputText value="#{mtmControl.attribute.attribute}" />
																</p:column>
															</p:row>
															<p:row>
																<p:column style="width:7%">
																	<p:commandButton icon="ui-icon-search" immediate="true"
																		actionListener="#{formViewController.updateMtmReferenceKeys}" 
																		update="olpanelpg_#{mtmBlock.entityID}_#{mtmControl.attribute.id}" >
																		<f:param name="CTRL_ID" value="#{mtmControl.attribute.id}" />
																		<f:param name="BLOCK_ID" value="#{mtmBlock.entityID}" />
																	</p:commandButton>
																</p:column>
																<p:column>
																	<p:inputText value="#{mtmControl.searchKeyWords}" style="width:96%" >
																		<p:ajax event="blur" update="@this" listener="#{formViewController.inlineReferenceChange}" />
																	</p:inputText>
																</p:column>
															</p:row>
														</f:facet>
														<c:forEach items="#{mtmControl.listReference}" var="ke">
															<p:row>
																<p:column style="width:7%">
																	<p:commandButton icon="ui-icon-circle-triangle-e"  immediate="true"
																		oncomplete="PF('wvolpanel_#{mtmBlock.entityID}_#{mtmControl.attribute.id}').hide();PF('dlg2').hide();" 
																		onstart="PF('dlg2').show();" 
																		actionListener="#{formViewController.autoCompleteMtmFieldSelect}" update="@form">
																		<f:param name="CTRL_BLOCK_ID" value="#{mtmBlock.entityID}" />
																		<f:param name="CTRL_ATT_ID" value="#{mtmControl.attribute.id}" />
																		<f:param name="CTRL_ATT_VAL" value="#{ke.key}" />
																	</p:commandButton>
																</p:column>
																<p:column>
																	<h:outputText value="#{ke.value}" />
																</p:column>
															</p:row>
														</c:forEach>
													</p:panelGrid>
												</p:scrollPanel>
												
												
											</p:overlayPanel> 
											
											
										</h:panelGrid>
									</h:panelGrid>
									
								</c:forEach>
								<f:facet name="footer">
									<p:commandButton actionListener="#{formViewController.mtmAdd}" immediate="true"
											value="Ajouter" update="mtmAccordion" onstart="PF('dlg2').show();"
											oncomplete="PF('dlg2').hide();showTab(#{loop.index});" />
								</f:facet>
							</p:panelGrid>

						</center>
					</h:panelGroup>
				</p:tab>
			</c:forEach>
			<!-- =============== Onglets pour les références ======================  -->
			<c:forEach var="mtmBlock" items="#{formViewController.refBlocks}" varStatus="loop">
				<p:ajax event="tabChange"
					listener="#{formViewController.onTabChange}" />
				<p:tab id="tabid_#{mtmBlock.entityID}" titleStyleClass="tab_title">
					<f:facet name="title">
		               <h:outputText value="#{mtmBlock.entity.name}" styleClass="tabTitle"/>
        	       	</f:facet>
					<h:panelGroup styleClass="tab_content onglet_#{mtmBlock.entityID}">
					
						<center>
							<p:panelGrid columns="4" style="width:100%" 
								columnClasses="mtmcols, mtmcols, mtmcols, mtmcols">

								<c:forEach items="#{mtmBlock.controls}" var="mtmControl">
									<h:panelGrid columns="3">
										<h:outputText value="#{mtmControl.label}" style="vertical-align: middle;"></h:outputText>
										<p:graphicImage style="margin-bottom: 6%;margin-left: 3%; width:5px" rendered="#{mtmControl.attribute.mandatory}"
												value="/img/create#{frontController.themeVar}.png" />
										<p:graphicImage value="img/bulb.png"
											title="La valeur de ce champs sera calculée de façon automatique"
											rendered="#{mtmControl.attribute.calculated}" />
									</h:panelGrid>
									<h:panelGrid columns="1">
										<p:inputText value="#{mtmControl.controlValue}"
											readonly="#{mtmControl.attribute.calculated}"
											styleClass="#{(!mtmControl.reference and !mtmControl.ctrlDate)?'showTextbox':'hideTextbox'}"
											rendered="#{!mtmControl.attribute.textarea and !mtmControl.reference and !mtmControl.ctrlDate and mtmControl.attribute.CAttributetype.id!=12}" 
											onclick="this.select();">
											<p:ajax event="blur" update="@this"></p:ajax>
										</p:inputText>
										
										<p:inputTextarea id="idtextarea_#{mtmControl.attribute.id}"
											value="#{mtmControl.controlValue}"
											readonly="#{mtmControl.attribute.calculated or uictrl.readOnly or uictrl.attribute.CAttributetype.id==7 }"
											rendered="#{mtmControl.attribute.textarea and !uictrl.reference and !uictrl.ctrlDate and uictrl.attribute.CAttributetype.id!=5 and uictrl.attribute.CAttributetype.id!=9 and uictrl.attribute.CAttributetype.id!=6}"
											onclick="this.select();" cols="20" rows="3" autoResize="true">
											<p:ajax event="blur" listener="#{formViewController.saveTextStatus}" />
										</p:inputTextarea>

										<p:selectBooleanCheckbox value="#{mtmControl.booleanValue}" 
											rendered="#{mtmControl.attribute.CAttributetype.id==12}" >
											<p:ajax event="change" listener="#{formViewController.dummyListener}" update="@this" />
										</p:selectBooleanCheckbox>
										
										<p:calendar pattern="#{frontController.localization.dateFormat}" locale="#{frontController.localization.langCode}" navigator="true"
											value="#{mtmControl.dateValue}"
											styleClass="#{(mtmControl.ctrlDate)?'showCalendar':'hideCalendar'}"
											rendered="#{mtmControl.ctrlDate}">
											<p:ajax event="blur" update="@this"></p:ajax>
										</p:calendar>

										<h:panelGrid columns="2">
										<p:selectOneMenu value="#{mtmControl.trueValue}"
											rendered="#{mtmControl.reference}"
											styleClass="#{(mtmControl.reference)?'dropdown':'hideTextbox'}"
											style="width:132px;" >
											<f:param name="mtmattribute1" value="#{mtmControl.attribute.id}" />
											<f:param name="mtmblock1" value="#{mtmBlock.entityID}" />
											<f:attribute name="mtmattribute" value="#{mtmControl.attribute.id}"></f:attribute>
											<f:attribute name="mtmblock" value="#{mtmBlock.entityID}"></f:attribute>
											<p:ajax event="change"
												listener="#{formViewController.checkingMtmChangeListener}"
												update="@form" onstart="PF('dlg2').show();"
												oncomplete="PF('dlg2').hide();$('.tab_content').parent('div.ui-tabs-panel').hide();$('.onglet_#{mtmBlock.entityID}').parent('div.ui-tabs-panel').show();">
												<f:setPropertyActionListener
													target="#{formViewController.selectedAttribute}"
													value="#{mtmControl.attribute}"></f:setPropertyActionListener>
												<f:setPropertyActionListener
													target="#{formViewController.changeMtmBlock }"
													value="#{mtmBlock}"></f:setPropertyActionListener>
											</p:ajax>
											<f:selectItem itemLabel="" itemValue="" />
											<f:selectItems var="ke" value="#{mtmControl.listReference}"
												itemValue="#{ke.value}" itemLabel="#{ke.value}"></f:selectItems>
										</p:selectOneMenu>
										<p:commandLink title="Créer une nouvelle valeur"
												process="@this" immediate="true"
												actionListener="#{formViewController.loadInlineComponents}"
												onstart="PF('dlg2').show();" update="@form"
												rendered="#{mtmControl.reference and mtmControl.attribute.id gt 0}"
												oncomplete="PF('inlineinsert').show();PF('dlg2').hide();">
												<p:graphicImage style="width:12px;margin-bottom: 6%;margin-left: 3%;" value="/img/add.png" />
												<f:param name="inlineDataReference" value="#{mtmControl.attribute.dataReference}" />
												<f:param name="inlineAttId" value="#{uictrl.attribute.id}" />
												
												<f:param name="mtmblock" value="#{mtmBlock.entityID}" />
											</p:commandLink>
										</h:panelGrid>
									</h:panelGrid>
								</c:forEach>
								<f:facet name="footer">
									
								</f:facet>
							</p:panelGrid>

						</center>
					</h:panelGroup>
				</p:tab>
			</c:forEach>
			<p:tab id="prflrls" rendered="#{formViewController.userRepresentative}">
				<f:facet name="title">
		        	<h:outputText value="Profils et rôles" styleClass="tabTitle"/>
        	    </f:facet>
        	    <p:panelGrid style="width:100%" columns="2">
        	    	<h:outputText value="Email/Identifiant" />
        	    	<p:inputText value="#{formViewController.userName}" style="width:150px" readonly="#{!formViewController.insert}" >
        	    		<p:ajax event="blur" listener="#{formViewController.ajaxValidate}" update="@this" />
					</p:inputText>
        	    </p:panelGrid>
				<p:spacer width="20" height="20" />
				<p:panel header="Profils" style="width:100%">
					<p:pickList id="profilspicklist" value="#{formViewController.picklistProfils}"
						  var="prf" itemLabel="#{prf}" itemValue="#{prf}" 
						  style="width:100%" showSourceFilter="true" showTargetFilter="true" 
						  showSourceControls="false" showTargetControls="false"  >
						 <p:ajax event="transfer" listener="#{formViewController.onTransfer}" update="rolespicklist" />
					</p:pickList>
				</p:panel>
				<p:spacer width="20" height="20" />
				<p:panel header="Rôles" style="width:100%">
					<p:pickList id="rolespicklist"  value="#{formViewController.picklistRoles}"  style="width:100%"
			 			 showSourceFilter="true" showTargetFilter="true" showSourceControls="false" showTargetControls="false" 
						 var="rl" itemLabel="#{rl}" itemValue="#{rl}" >
						 <p:ajax event="transfer" listener="#{formViewController.onDummyTransfer}" update="@this" />
					</p:pickList>
				</p:panel>
				
			</p:tab>
		</p:tabView>
		
		<iframe style="width:100%; height:600px;display:#{(formViewController.window.id eq 2182 or formViewController.window.id eq 2180)?'block':'none'}" 
			 src="http://ns389914.ovh.net/proto_audial/audio_graphe.html" />
		
		<script>
			$(document).ready(function(){
				showTab(0);
			});
			function showTab(indx) {
				var length = $(".tab_content").length;
				if(length > 0) {
					$(".tab_content").each(function(){
						$(this).parents(".ui-tabs-panel:first").hide();
					});
					var obj = $(".tab_content")[indx];
					$(obj).parents(".ui-tabs-panel:first").show();
				}
			}
		</script>
		<center>


			<p:scrollPanel id="scrolldatapanel"
				rendered="#{formViewController.insert}" widgetVar="scrolldatapanel" mode="native">
				<p:panelGrid id="listViewTable" style="width:100%; border: 1px solid #a8a8a8;">
					<f:facet name="header">
						<p:row>
							<c:forEach items="#{formViewController.titles}" var="ttl">
								<p:column>#{ttl}</p:column>
							</c:forEach>
						</p:row>
					</f:facet>
					<c:forEach items="#{formViewController.values}" var="uval">
						<p:row>
							<c:forEach items="#{uval.value}" var="tval">
								<p:column>
							#{tval}
						</p:column>
							</c:forEach>
						</p:row>
					</c:forEach>

				</p:panelGrid>
			</p:scrollPanel>

		</center>
	</ui:define>

	<ui:define name="aide">
		<p:panel closable="true" rendered="#{frontController.showRightPanel}"
			toggleable="true" collapsed="true" style="width:100%">
			<f:facet name="header">Aide</f:facet>
			<p>
				&nbps;
				Les écrans en formulaires vous permettent de saisir ou modifier les
				données
			</p>
			<p>Si un champs ne peut être édité un indicateur (ampoule jaune)
				vous indiquera la raison</p>
			<p>&nbsp;A la fin de la saisie le bouton enregistrer sauvegardera
				les données</p>
			<p>&nbsp;Afin de simplifier la navigation le bouton suivant vous
				raménera vers la rubrique suivante</p>
			<h:outputText rendered="#{frontController.linksAvailable}">
				<p>&nbsp;Dans le menu "Raccourcis" vous pouvez retrouver les
					différentes rubriques liées à l'écran en cours</p>
			</h:outputText>
			<p>&nbsp;Vous pouvez aussi revenir au menu principal à partir du
				menu outils</p>
		</p:panel>
	</ui:define>

</ui:composition>
</html>